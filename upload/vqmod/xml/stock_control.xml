<modification>
	<id>Stock control for Opencart 1.5.4.1</id>
	<version>1.2</version>
	<vqmver>2.2.2</vqmver>
	<author>support@bluebit.co.uk</author>

	<file name="admin/controller/catalog/product.php">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[private function getList() {]]></search>
			<add><![CDATA[
		$this->load->model('localisation/stock_status');
		
	    $this->data['stock_statuses'] = $this->model_localisation_stock_status->getStockStatuses();
		
		if (isset($this->request->get['filter_out_of_stock_status'])) {
			$filter_out_of_stock_status = $this->request->get['filter_out_of_stock_status'];
		} else {
			$filter_out_of_stock_status = NULL;
		}

		if (isset($this->request->get['filter_on_order'])) {
			$filter_on_order = $this->request->get['filter_on_order'];
		} else {
			$filter_on_order = NULL;
		}

		if (isset($this->request->get['filter_description'])) {
			$filter_description = $this->request->get['filter_description'];
		} else {
			$filter_description = NULL;
		}
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[$this->data['breadcrumbs'] = array();]]></search>
			<add><![CDATA[
		if (isset($this->request->get['filter_on_order'])) {
			$url .= '&filter_on_order=' . $this->request->get['filter_on_order'];
		}

		if (isset($this->request->get['filter_out_of_stock_status'])) {
			$url .= '&filter_out_of_stock_status=' . $this->request->get['filter_out_of_stock_status'];
		}

		if (isset($this->request->get['filter_description'])) {
			$url .= '&filter_description=' . $this->request->get['filter_description'];
		}
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA['filter_status'   => $filter_status,]]></search>
			<add><![CDATA[
			'filter_description' => $filter_description,
			'filter_out_of_stock_status'   => $filter_out_of_stock_status,
			'filter_on_order'   => $filter_on_order,
		]]>
			</add>
		</operation>
		<operation error="error" index="1">
			<search position="after"><![CDATA[$this->data['products'][] = array(]]></search>
			<add><![CDATA[
				'description' => html_entity_decode($result['description'], ENT_QUOTES, 'UTF-8'),
				'stock_status_name' => $result['stock_status_name'],
				'on_order' => $result['on_order'],
		]]>
			</add>
		</operation>
		<operation error="error" index="1">
			<search position="after"><![CDATA[$this->data['column_action'] = $this->language->get('column_action');]]></search>
			<add><![CDATA[
		$this->data['column_on_order'] = $this->language->get('column_on_order');
		$this->data['column_out_of_stock_status'] = $this->language->get('column_out_of_stock_status');
		$this->data['column_description'] = $this->language->get('column_description');
		]]>
			</add>
		</operation>
		<operation error="error" index="1">
			<search position="before"><![CDATA[if ($order == 'ASC') {]]></search>
			<add><![CDATA[
		if (isset($this->request->get['filter_description'])) {
			$url .= '&filter_description=' . $this->request->get['filter_description'];
		}

		if (isset($this->request->get['filter_out_of_stock_status'])) {
			$url .= '&filter_out_of_stock_status=' . $this->request->get['filter_out_of_stock_status'];
		}

		if (isset($this->request->get['filter_on_order'])) {
			$url .= '&filter_on_order=' . $this->request->get['filter_on_order'];
		}
		]]>
			</add>
		</operation>
		<operation error="error" index="1">
			<search position="after"><![CDATA[$this->data['sort_order'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.sort_order' . $url, 'SSL');]]></search>
			<add><![CDATA[
		$this->data['sort_description'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=pd.description' . $url, 'SSL');
		$this->data['sort_on_order'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=on_order' . $url, 'SSL');
		$this->data['sort_out_of_stock_status'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=ss.name' . $url, 'SSL');
		]]>
			</add>
		</operation>
		<operation error="error" index="7">
			<search position="before"><![CDATA[if (isset($this->request->get['sort'])) {]]></search>
			<add><![CDATA[
		if (isset($this->request->get['filter_description'])) {
			$url .= '&filter_description=' . $this->request->get['filter_description'];
		}

		if (isset($this->request->get['filter_out_of_stock_status'])) {
			$url .= '&filter_out_of_stock_status=' . $this->request->get['filter_out_of_stock_status'];
		}

		if (isset($this->request->get['filter_on_order'])) {
			$url .= '&filter_on_order=' . $this->request->get['filter_on_order'];
		}
		]]>
			</add>
		</operation>
		<operation error="error" index="1">
			<search position="after"><![CDATA[$this->data['filter_status'] = $filter_status;]]></search>
			<add><![CDATA[
		$this->data['filter_description'] = $filter_description;
		$this->data['filter_out_of_stock_status'] = $filter_out_of_stock_status;
		$this->data['filter_on_order'] = $filter_on_order;
		]]>
			</add>
		</operation>
		<operation error="error" index="1">
			<search position="before"><![CDATA[$this->load->model('design/layout');]]></search>
			<add><![CDATA[
		if (isset($this->request->get['product_id'])) {
		    $this->data['show_stock_control'] = true;
		    $product_id = $this->request->get['product_id'];
		    $this->data['stock_history'] = $this->model_catalog_product->getStockHistory($product_id);
		    $this->data['tab_stock_control'] = $this->language->get('tab_stock_control');
		    $this->data['text_type'] = $this->language->get('text_type');
		    $this->data['text_adjustment'] = $this->language->get('text_adjustment');
		    $this->data['text_new_quantity'] = $this->language->get('text_new_quantity');
		    $this->data['text_notes'] = $this->language->get('text_notes');
		    $this->data['text_admin'] = $this->language->get('text_admin');
		    $this->data['text_date'] = $this->language->get('text_date');

		    $totalRows = $this->model_catalog_product->getTotalStockHistory($product_id);
		    $limit =$this->config->get('config_admin_limit');
		    $url = '&product_id=' . $product_id;
		    $pagination = new Pagination();
		    $pagination->total = $totalRows;
		    $pagination->page = 1;
		    $pagination->limit = $limit;
		    $pagination->text = $this->language->get('text_pagination');
		    $pagination->url = HTTPS_SERVER . 'index.php?route=catalog/product/getstockrows&token=' . $this->session->data['token'] . $url . '&page={page}';
		    $this->data['pagination'] = $pagination->render();
		}
		else {
		    $this->data['show_stock_control'] = false;
		}
		]]>
			</add>
		</operation>
		<operation error="error" index="1">
			<search position="before" offset="1" index="1"><![CDATA[?>]]></search>
			<add><![CDATA[
	public function getStockRows() {

		$this->load->model('catalog/product');

		if (isset($this->request->get['page'])) {
			$page = $this->request->get['page'];
		}
		else {
			$page = 1;
		}

		$limit = $this->config->get('config_admin_limit');

		$start = ($page - 1) * $limit;

		$product_id = $this->request->get['product_id'];
		$results = $this->model_catalog_product->getStockHistory($product_id, $start);

		$html = '';

		foreach ($results as $result) {
			$html .= '<tr>';
			$html .= '<td class="left">' . ucwords($result['type']) . '</td>';
			$html .= '<td class="left">' . $result['adjustment'] . '</td>';
			$html .= '<td class="left">' . $result['new_quantity'] . '</td>';
			$html .= '<td class="left">' . $result['notes'] . '</td>';
			$html .= '<td class="left">' . $result['admin'] . '</td>';
			$html .= '<td class="left">' . $result['date'] . '</td>';
			$html .= '</tr>';
		}

		$totalRows = $this->model_catalog_product->getTotalStockHistory($product_id);

		$url = '&product_id=' . $product_id;
		$pagination = new Pagination();
		$pagination->total = $totalRows;
		$pagination->page = $page;
		$pagination->limit = $limit;
		$pagination->text = $this->language->get('text_pagination');
		$pagination->url = HTTPS_SERVER . 'index.php?route=catalog/product/getstockrows&token=' . $this->session->data['token'] . $url . '&page={page}';

		$json['html'] = $html;
		$json['pagination'] = $pagination->render();

		$this->response->setOutput(json_encode($json));
	}

	public function autoCompleteProductName() {

		$this->load->model('catalog/product');

		$data = array();
		$data['filter_name'] = $this->request->get['q'];

		$products = $this->model_catalog_product->getProducts($data);

		$json = array();

		foreach ($products as $product) {
			$json[] = html_entity_decode($product['name'], ENT_QUOTES, 'UTF-8');
		}

		$this->response->setOutput(json_encode($json));
	}
		]]>
			</add>
		</operation>
	</file>
	
	<file name="admin/controller/common/header.php">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$this->data['text_zone'] = $this->language->get('text_zone');]]></search>
			<add><![CDATA[
		$this->data['text_stock_control'] = $this->language->get('text_stock_control');
		$this->data['text_suppliers'] = $this->language->get('text_suppliers');
		$this->data['text_out_of_stock_statuses'] = $this->language->get('text_out_of_stock_statuses');
		$this->data['text_stock_received'] = $this->language->get('text_stock_received');
		$this->data['text_purchase_orders'] = $this->language->get('text_purchase_orders');
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$this->data['zone'] = $this->url->link('localisation/zone', 'token=' . $this->session->data['token'], 'SSL');]]></search>
			<add><![CDATA[
			$this->data['stock_received'] = $this->url->link('catalog/stock_received', 'token=' . $this->session->data['token'], 'SSL');
			$this->data['purchase_orders'] = $this->url->link('catalog/purchase_order', 'token=' . $this->session->data['token'], 'SSL');
			$this->data['suppliers'] = $this->url->link('catalog/supplier', 'token=' . $this->session->data['token'], 'SSL');
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/controller/localisation/stock_status.php">
		
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$this->data['stock_statuses'][] = array(]]></search>
			<add><![CDATA[
				'allow_checkout'  => $result['allow_checkout'] == 0 ? 'No' : 'Yes',
				'hide_from_catalog' => $result['hide_from_catalog'] == 0 ? 'No' : 'Yes',
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$this->data['column_action'] = $this->language->get('column_action');]]></search>
			<add><![CDATA[
		$this->data['column_hide_from_catalog'] = $this->language->get('column_hide_from_catalog');
		$this->data['column_allow_checkout'] = $this->language->get('column_allow_checkout');
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$this->data['entry_sort_order'] = $this->language->get('entry_sort_order');]]></search>
			<add><![CDATA[
		$this->data['entry_hide_from_catalog'] = $this->language->get('entry_hide_from_catalog');
		$this->data['entry_allow_checkout'] = $this->language->get('entry_allow_checkout');
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[$this->template = 'localisation/stock_status_form.tpl';]]></search>
			<add><![CDATA[
		$first_key = key($this->data['stock_status']);
		if ($first_key) {
			$this->data['stock_status_hide_from_catalog'] = $this->data['stock_status'][$first_key]['hide_from_catalog'];
			$this->data['stock_status_allow_checkout'] = $this->data['stock_status'][$first_key]['allow_checkout'];
		}
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/language/english/catalog/product.php">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$_['text_amount']            = 'Fixed Amount';]]></search>
			<add><![CDATA[
$_['text_type']	             = 'Type';
$_['text_adjustment']        = 'Adjustment';
$_['text_new_quantity']      = 'New quantity';
$_['text_notes']             = 'Notes';
$_['text_admin']             = 'Admin';
$_['text_date']              = 'Date';
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$_['column_action']          = 'Action';]]></search>
			<add><![CDATA[
$_['column_on_order']        = 'On order';
$_['column_out_of_stock_status'] = 'Out of stock type';
$_['column_description']     = 'Description';
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/language/english/common/header.php">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$_['text_zone']                        = 'Zones';]]></search>
			<add><![CDATA[
$_['text_stock_control']     = 'Stock Control';
$_['text_suppliers']         = 'Suppliers';
$_['text_stock_received']    = 'Stock Received';
$_['text_purchase_orders']   = 'Purchase Orders';
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/language/english/english.php">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$_['button_reset']            = 'Reset';]]></search>
			<add><![CDATA[
$_['button_update']           = 'Update';
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$_['tab_voucher_history']     = 'Voucher History';]]></search>
			<add><![CDATA[
$_['tab_stock_control']       = 'Stock Control';
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/language/english/localisation/stock_status.php">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$_['column_action']    = 'Action';]]></search>
			<add><![CDATA[
$_['column_hide_from_catalog']  = 'Hide from catalog when zero stock';
$_['column_allow_checkout']  	= 'Allow checkout when zero stock';
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$_['entry_name']       = 'Stock Status Name:';]]></search>
			<add><![CDATA[
$_['entry_allow_checkout'] = 'Allow checkout when zero stock:';
$_['entry_hide_from_catalog'] = 'Hide from catalog when zero stock:';
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/model/catalog/product.php">
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "product_option_value SET product_option_id = '" . (int)$product_option_id . "', product_id = '" . (int)$product_id . "', option_id = '" . (int)$product_option['option_id'] . "', option_value_id = '" . (int)$product_option_value['option_value_id'] . "', quantity = '" . (int)$product_option_value['quantity'] . "', subtract = '" . (int)$product_option_value['subtract'] . "', price = '" . (float)$product_option_value['price'] . "', price_prefix = '" . $this->db->escape($product_option_value['price_prefix']) . "', points = '" . (int)$product_option_value['points'] . "', points_prefix = '" . $this->db->escape($product_option_value['points_prefix']) . "', weight = '" . (float)$product_option_value['weight'] . "', weight_prefix = '" . $this->db->escape($product_option_value['weight_prefix']) . "'");]]></search>
			<add><![CDATA[
							$this->db->query("INSERT INTO " . DB_PREFIX . "product_option_value SET product_option_id = '" . (int)$product_option_id . "', product_id = '" . (int)$product_id . "', option_id = '" . (int)$product_option['option_id'] . "', option_value_id = '" . (int)$product_option_value['option_value_id'] . "', quantity = '" . (int)$product_option_value['quantity'] . "', subtract = '" . (int)$product_option_value['subtract'] . "', price = '" . (float)$product_option_value['price'] . "', price_prefix = '" . $this->db->escape($product_option_value['price_prefix']) . "', points = '" . (int)$product_option_value['points'] . "', points_prefix = '" . $this->db->escape($product_option_value['points_prefix']) . "', weight = '" . (float)$product_option_value['weight'] . "', weight_prefix = '" . $this->db->escape($product_option_value['weight_prefix']) . "', sort_order = '" . (int)$product_option_value['sort_order'] . "'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$this->db->query("UPDATE " . DB_PREFIX . "product SET model = '" . $this->db->escape($data['model']) . "', sku = '" . $this->db->escape($data['sku']) . "', upc = '" . $this->db->escape($data['upc']) . "', ean = '" . $this->db->escape($data['ean']) . "', jan = '" . $this->db->escape($data['jan']) . "', isbn = '" . $this->db->escape($data['isbn']) . "', mpn = '" . $this->db->escape($data['mpn']) . "', location = '" . $this->db->escape($data['location']) . "', quantity = '" . (int)$data['quantity'] . "', minimum = '" . (int)$data['minimum'] . "', subtract = '" . (int)$data['subtract'] . "', stock_status_id = '" . (int)$data['stock_status_id'] . "', date_available = '" . $this->db->escape($data['date_available']) . "', manufacturer_id = '" . (int)$data['manufacturer_id'] . "', shipping = '" . (int)$data['shipping'] . "', price = '" . (float)$data['price'] . "', points = '" . (int)$data['points'] . "', weight = '" . (float)$data['weight'] . "', weight_class_id = '" . (int)$data['weight_class_id'] . "', length = '" . (float)$data['length'] . "', width = '" . (float)$data['width'] . "', height = '" . (float)$data['height'] . "', length_class_id = '" . (int)$data['length_class_id'] . "', status = '" . (int)$data['status'] . "', tax_class_id = '" . $this->db->escape($data['tax_class_id']) . "', sort_order = '" . (int)$data['sort_order'] . "', date_modified = NOW() WHERE product_id = '" . (int)$product_id . "'");]]></search>
			<add><![CDATA[
		$this->db->query("UPDATE " . DB_PREFIX . "product SET model = '" . $this->db->escape($data['model']) . "', sku = '" . $this->db->escape($data['sku']) . "', upc = '" . $this->db->escape($data['upc']) . "', ean = '" . $this->db->escape($data['ean']) . "', jan = '" . $this->db->escape($data['jan']) . "', isbn = '" . $this->db->escape($data['isbn']) . "', mpn = '" . $this->db->escape($data['mpn']) . "', location = '" . $this->db->escape($data['location']) . "',                                              minimum = '" . (int)$data['minimum'] . "', subtract = '" . (int)$data['subtract'] . "', stock_status_id = '" . (int)$data['stock_status_id'] . "', date_available = '" . $this->db->escape($data['date_available']) . "', manufacturer_id = '" . (int)$data['manufacturer_id'] . "', shipping = '" . (int)$data['shipping'] . "', price = '" . (float)$data['price'] . "', points = '" . (int)$data['points'] . "', weight = '" . (float)$data['weight'] . "', weight_class_id = '" . (int)$data['weight_class_id'] . "', length = '" . (float)$data['length'] . "', width = '" . (float)$data['width'] . "', height = '" . (float)$data['height'] . "', length_class_id = '" . (int)$data['length_class_id'] . "', status = '" . (int)$data['status'] . "', tax_class_id = '" . $this->db->escape($data['tax_class_id']) . "', sort_order = '" . (int)$data['sort_order'] . "', date_modified = NOW() WHERE product_id = '" . (int)$product_id . "'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id. "'");]]></search>
			<add><![CDATA[
		if (isset($data['stock_control_adjustment'])) {
			$adjustment = (int) $data['stock_control_adjustment'];
                        $date_sql = "";
			if ($adjustment != 0) {
                                if ($adjustment > 0){ $date_sql=", date_available =NOW() "; }
				$this->db->query("UPDATE " . DB_PREFIX . "product SET quantity = quantity + " . $adjustment . $date_sql . " WHERE product_id = " . (int)$product_id);
				$result = $this->db->query("SELECT quantity FROM " . DB_PREFIX . "product WHERE product_id = " . (int)$product_id);
				$newdata = $result->row;
				$this->db->query("INSERT INTO " . DB_PREFIX . "stock_control (type, product_id, product_name, adjustment, new_quantity, notes, admin_id, date) VALUES (
				'" . $this->db->escape($data['stock_control_type']) . "',
				" . (int)$product_id . ",
				'" . $this->db->escape($data['product_description'][1]['name']) . "',
				" . $adjustment . ",
				" . $newdata['quantity'] . ",
				'" . $this->db->escape($data['stock_control_notes']) . "',
				'" . $this->session->data['user_id'] . "',
				NOW())");
			}
		}
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$sql = "SELECT * FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id)";]]></search>
			<add><![CDATA[
			$sql = "SELECT SUM(pop.quantity_outstanding) AS on_order, p.*, pd.*, ss.name AS stock_status_name FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN stock_status ss ON ss.stock_status_id = p.stock_status_id AND ss.language_id = '" . (int)$this->config->get('config_language_id') . "' LEFT JOIN purchase_order_product pop ON pop.product_id = p.product_id";
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="2"><![CDATA[if (!empty($data['filter_category'])) {]]></search>
			<add><![CDATA[
			if (isset($data['filter_out_of_stock_status']) && !is_null($data['filter_out_of_stock_status'])) {
				$sql .= " AND p.stock_status_id = '" . (int)$data['filter_out_of_stock_status'] . "'";
			}
			
			if (isset($data['filter_description']) && !is_null($data['filter_description'])) {
				$sql .= " AND LCASE(pd.description) LIKE '%" . $this->db->escape(strtolower($data['filter_description'])) . "%'";
			}
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$sort_data = array(]]></search>
			<add><![CDATA[
				'ss.name',
				'on_order',
				'pd.description',
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[if (isset($data['sort']) && in_array($data['sort'], $sort_data)) {]]></search>
			<add><![CDATA[
			if (isset($data['filter_on_order']) && !is_null($data['filter_on_order'])) {
				if ($data['filter_on_order'] == 1) {
				    $sql .= " HAVING on_order > 0";
				}
				else if ($data['filter_on_order'] == -1) {
				    $sql .= " HAVING on_order = 0 OR on_order IS NULL";
				}
			}
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA['required'          => $product_option['required']]]></search>
			<add><![CDATA[
					'required'          => $product_option['required'],
					'product_option_value' => $product_option_value_data
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" offset="2" index="1"><![CDATA[?>]]></search>
			<add><![CDATA[
	}
	
	public function addProductQuantity($product_id, $quantity) {
		$query = $this->db->query("UPDATE " . DB_PREFIX . "product SET quantity = quantity + " . (int) $quantity . " WHERE product_id = " . (int) $product_id . " AND 
subtract = 1");
	}

	public function addProductOptionValueQuantity($product_option_value_id, $quantity) {
		$query = $this->db->query("UPDATE " . DB_PREFIX . "product_option_value SET quantity = quantity + " . (int) $quantity . " WHERE product_option_value_id = " . 
(int) $product_option_value_id . " AND subtract = 1");
	}

	public function getTotalStockHistory($product_id) {
	    $query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "stock_control WHERE product_id = '" . (int)$product_id . "'");
	    return $query->row['total'];
	}

	public function getStockHistory($product_id, $start = 0) {
	    $this->load->model('user/user');
	    $limit = $this->config->get('config_admin_limit');
	    $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "stock_control WHERE product_id = '" . (int)$product_id . "' ORDER BY date DESC, id DESC LIMIT " . (int)$start . "," . (int)$limit);

	    $history = array();
	    foreach ($query->rows as $result) {
		if ($result['adjustment'] >= 0) {
		    $result['adjustment'] = "+" . $result['adjustment'];
		}
		$result['notes'] = nl2br($result['notes']);
		if (!is_null($result['admin_id'])) {
		    $user = $this->model_user_user->getUser($result['admin_id']);
		    $result['admin'] = $user['username'];
		}
		else {
		     $result['admin'] = '-';
		}
		$history[] = $result;
	    }
	    return $history;
	
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/model/localisation/stock_status.php">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$stock_status_id = $this->db->getLastId();]]></search>
			<add><![CDATA[
				$hide_from_catalog = $data['stock_status_hide_from_catalog'] == 1 ? 1 : 0;
				$allow_checkout = $data['stock_status_allow_checkout'] == 1 ? 1 : 0;

				$this->db->query("INSERT INTO " . DB_PREFIX . "stock_status_actions SET stock_status_id = '" . (int)$stock_status_id . "', hide_from_catalog = '" . $hide_from_catalog . "', allow_checkout = '" . $allow_checkout . "'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "stock_status WHERE stock_status_id = '" . (int)$stock_status_id . "'");]]></search>
			<add><![CDATA[
		$this->db->query("DELETE FROM " . DB_PREFIX . "stock_status_actions WHERE stock_status_id = '" . (int)$stock_status_id . "'");
		$hide_from_catalog = $data['stock_status_hide_from_catalog'] == 1 ? 1 : 0;
		$allow_checkout = $data['stock_status_allow_checkout'] == 1 ? 1 : 0;
		$this->db->query("INSERT INTO " . DB_PREFIX . "stock_status_actions SET stock_status_id = '" . (int)$stock_status_id . "', hide_from_catalog = '" . $hide_from_catalog . "', allow_checkout = '" . $allow_checkout . "'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "stock_status WHERE stock_status_id = '" . (int)$stock_status_id . "' AND language_id = '" . (int)$this->config->get('config_language_id') . "'");]]></search>
			<add><![CDATA[
		$query = $this->db->query("SELECT *, ssa.hide_from_catalog, ssa.allow_checkout FROM " . DB_PREFIX . "stock_status LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = " . DB_PREFIX . "stock_status.stock_status_id WHERE stock_status_id = '" . (int)$stock_status_id . "' AND language_id = '" . (int)$this->config->get('config_language_id') . "'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$sql = "SELECT * FROM " . DB_PREFIX . "stock_status WHERE language_id = '" . (int)$this->config->get('config_language_id') . "'";]]></search>
			<add><![CDATA[
		$sql = "SELECT *, ssa.hide_from_catalog, ssa.allow_checkout FROM " . DB_PREFIX . "stock_status LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON " . DB_PREFIX . "ssa.stock_status_id = " . DB_PREFIX . "stock_status.stock_status_id WHERE language_id = '" . (int)$this->config->get('config_language_id') . "'";
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$query = $this->db->query("SELECT stock_status_id, name FROM " . DB_PREFIX . "stock_status WHERE language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY name");]]></search>
			<add><![CDATA[
$query = $this->db->query("SELECT ss.stock_status_id, ss.name, ssa.hide_from_catalog, ssa.allow_checkout FROM " . DB_PREFIX . "stock_status ss LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON " . DB_PREFIX . "ssa.stock_status_id = " . DB_PREFIX . "ss.stock_status_id WHERE language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY name");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "stock_status WHERE stock_status_id = '" . (int)$stock_status_id . "'");]]></search>
			<add><![CDATA[
		$query = $this->db->query("SELECT *, ssa.hide_from_catalog, ssa.allow_checkout FROM " . DB_PREFIX . "stock_status LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON " . DB_PREFIX . "ssa.stock_status_id = " . DB_PREFIX . "stock_status.stock_status_id  WHERE stock_status.stock_status_id = '" . (int)$stock_status_id . "'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$stock_status_data[$result['language_id']] = array('name' => $result['name']);]]></search>
			<add><![CDATA[
			$stock_status_data[$result['language_id']] = array(
				'name' => $result['name'],
				'allow_checkout' => $result['allow_checkout'],
				'hide_from_catalog' => $result['hide_from_catalog']
			);
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/view/template/catalog/product_form.tpl">
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[<div id="tabs" class="htabs"><a href="#tab-general"><?php echo $tab_general; ?></a><a href="#tab-data"><?php echo $tab_data; ?></a><a href="#tab-links"><?php echo $tab_links; ?></a><a href="#tab-attribute"><?php echo $tab_attribute; ?></a><a href="#tab-option"><?php echo $tab_option; ?></a><a href="#tab-discount"><?php echo $tab_discount; ?></a><a href="#tab-special"><?php echo $tab_special; ?></a><a href="#tab-image"><?php echo $tab_image; ?></a><a href="#tab-reward"><?php echo $tab_reward; ?></a><a href="#tab-design"><?php echo $tab_design; ?></a></div>]]></search>
			<add><![CDATA[
<div id="tabs" class="htabs"><a href="#tab-general"><?php echo $tab_general; ?></a><a href="#tab-data"><?php echo $tab_data; ?></a><a href="#tab-links"><?php echo $tab_links; ?></a><a href="#tab-attribute"><?php echo $tab_attribute; ?></a><a href="#tab-option"><?php echo $tab_option; ?></a><a href="#tab-discount"><?php echo $tab_discount; ?></a><a href="#tab-special"><?php echo $tab_special; ?></a><a href="#tab-image"><?php echo $tab_image; ?></a><a href="#tab-reward"><?php echo $tab_reward; ?></a><a href="#tab-design"><?php echo $tab_design; ?></a><?php if ($show_stock_control) { ?><a href="#tab_stock_control"><?php echo $tab_stock_control; ?></a><?php } ?></div>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[<td><input type="text" name="quantity" value="<?php echo $quantity; ?>" size="2" /></td>]]></search>
			<add><![CDATA[
              <td><?php echo $quantity; ?></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[</form>]]></search>
			<add><![CDATA[
		  <?php if ($show_stock_control) { ?>
	<div id="tab_stock_control">
	    <table class="form">
            <tbody>
		<tr>
                  <td>Adjustment type:</td>
                  <td><select name="stock_control_type"><option value="restock">Restock</option><option value="manual">Manual adjustment</option><option value="stocktake">Stock Take</option><option value="faulty">Faulty Item</option><option value="error">Picking Error</option></select>
                </td>
		<tr>
                  <td>Adjustment:</td>
                  <td><input type="text" value="" size="3" name="stock_control_adjustment">
                </td>
		<tr>
                  <td>Notes:</td>
                  <td><textarea rows="5" cols="40" name="stock_control_notes"></textarea></td>
            </tr>
          </tbody>
	</table>
	<table id="stock_control" class="list">
          <thead>
            <tr>
              <td class="left"><?php echo $text_type; ?></td>
              <td class="left"><?php echo $text_adjustment; ?></td>
	      <td class="left"><?php echo $text_new_quantity; ?></td>
              <td class="left"><?php echo $text_notes; ?></td>
              <td class="left"><?php echo $text_admin; ?></td>
              <td class="left"><?php echo $text_date; ?></td>
            </tr>
          </thead>
          <tbody>
	    <?php foreach ($stock_history as $line) { ?>
            <tr>
              <td class="left"><?php echo str_replace('_', ' ', ucwords($line['type'])); ?></td>
              <td class="left"><?php echo $line['adjustment']; ?></td>
	      <td class="left"><?php echo $line['new_quantity']; ?></td>
	      <td class="left"><?php echo $line['notes']; ?></td>
	      <td class="left"><?php echo $line['admin']; ?></td>
	      <td class="left"><?php echo $line['date']; ?></td>
            </tr>
            <?php } ?>
	  </tbody>
        </table>
		<div id="stock_pagination" class="pagination"><?php echo $pagination; ?></div>
      </div>
	<?php } ?>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[<?php echo $footer; ?>]]></search>
			<add><![CDATA[
//-->
<script type="text/javascript">
$(document).ready(function() {
    $('#stock_pagination a').live('click', function(e) {
		e.preventDefault();
		url = $(this).attr('href');
		$.ajax({
			url: url,
			dataType: 'json',
			success: function(data) {
			$('#stock_pagination').html(data.pagination);
			$('table#stock_control tbody').html(data.html);
			$("table#stock_control tbody tr:even").css("background-color", "#F4F4F8");
			}
		})
	})
});
</script> 
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/view/template/catalog/product_list.tpl">
		<operation error="abort">
			<search position="before" index="1"><![CDATA[<td class="right"><?php if ($sort == 'p.price') { ?>]]></search>
			<add><![CDATA[
			   <td class="left"><?php if ($sort == 'pd.description') { ?>
              <a href="<?php echo $sort_description; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_description; ?></a>
              <?php } else { ?>
              <a href="<?php echo $sort_description; ?>"><?php echo $column_description; ?></a>
              <?php } ?></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[<td class="right"><?php echo $column_action; ?></td>]]></search>
			<add><![CDATA[
			  <td class="left"><?php if ($sort == 'on_order') { ?>
              <a href="<?php echo $sort_on_order; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_on_order; ?></a>
              <?php } else { ?>
              <a href="<?php echo $sort_on_order; ?>"><?php echo $column_on_order; ?></a>
              <?php } ?></td>
            <td class="left"><?php if ($sort == 'ss.name') { ?>
              <a href="<?php echo $sort_out_of_stock_status; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_out_of_stock_status; ?></a>
              <?php } else { ?>
              <a href="<?php echo $sort_out_of_stock_status; ?>"><?php echo $column_out_of_stock_status; ?></a>
              <?php } ?></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[<td><input type="text" name="filter_model" value="<?php echo $filter_model; ?>" /></td>]]></search>
			<add><![CDATA[
              <td><input type="text" name="filter_description" value="<?php echo $filter_description; ?>" /></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[<td align="right"><a onclick="filter();" class="button"><?php echo $button_filter; ?></a></td>]]></search>
			<add><![CDATA[
				<td><select name="filter_on_order">
                <option value="*"></option>
                <?php if ($filter_on_order == 1) { ?>
                <option value="1" selected="selected">Stock on order</option>
                <?php } else { ?>
                <option value="1">Stock on order</option>
                <?php } ?>
                <?php if ($filter_on_order == -1) { ?>
                <option value="-1" selected="selected">No stock on order</option>
                <?php } else { ?>
                <option value="-1">No stock on order</option>
                <?php } ?>
                </select></td>
              <td><select name="filter_out_of_stock_status">
                <option value="*"></option>
                <?php foreach ($stock_statuses as $stock_status) { ?>
                <?php if ($stock_status['stock_status_id'] == $filter_out_of_stock_status) { ?>
                <option value="<?php echo $stock_status['stock_status_id']; ?>" selected="selected"><?php echo $stock_status['name']; ?></option>
                <?php } else { ?>
                 <option value="<?php echo $stock_status['stock_status_id']; ?>"><?php echo $stock_status['name']; ?></option>
                <?php } ?>
                 <?php } ?>
              </select></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[<td class="left"><?php echo $product['model']; ?></td>]]></search>
			<add><![CDATA[
			  <td class="left"><div style="max-height:200px;overflow:auto;"><?php echo $product['description']; ?></div></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[<td class="left"><?php echo $product['status']; ?></td>]]></search>
			<add><![CDATA[
			  <td class="left"><?php echo $product['on_order']; ?></td>
              <td class="left"><?php echo $product['stock_status_name']; ?></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[<td class="center" colspan="8"><?php echo $text_no_results; ?></td>]]></search>
			<add><![CDATA[
              <td class="center" colspan="11"><?php echo $text_no_results; ?></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[location = url;]]></search>
			<add><![CDATA[
	var filter_description = $('input[name=\'filter_description\']').attr('value');

	if (filter_description) {
		url += '&filter_description=' + encodeURIComponent(filter_description);
	}

	var filter_out_of_stock_status = $('select[name=\'filter_out_of_stock_status\']').attr('value');

	if (filter_out_of_stock_status != '*') {
		url += '&filter_out_of_stock_status=' + encodeURIComponent(filter_out_of_stock_status);
	}

	var filter_on_order = $('select[name=\'filter_on_order\']').attr('value');

	if (filter_on_order != '*') {
		url += '&filter_on_order=' + encodeURIComponent(filter_on_order);
	}
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/view/template/common/header.tpl">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[<li><a href="<?php echo $information; ?>"><?php echo $text_information; ?></a></li>]]></search>
			<add><![CDATA[
		  <li><a class="parent"><?php echo $text_stock_control; ?></a>
	        <ul>
		      <li><a href="<?php echo $stock_received; ?>"><?php echo $text_stock_received; ?></a></li>
		      <li><a href="<?php echo $purchase_orders; ?>"><?php echo $text_purchase_orders; ?></a></li>
		      <li><a href="<?php echo $suppliers; ?>"><?php echo $text_suppliers; ?></a></li>
	        </ul>
	      </li>
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/view/template/localisation/stock_status_form.tpl">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[<table class="form">]]></search>
			<add><![CDATA[
		  <tr>
          <td><span class="required">*</span> <?php echo $entry_hide_from_catalog; ?></td>
          <td>
          <select name="stock_status_hide_from_catalog">
              <?php if ($stock_status_hide_from_catalog) { ?>
              <option value="1" selected="selected">Yes</option>
              <option value="0">No</option>
              <?php } else { ?>
                <option value="1">Yes</option>
              <option value="0" selected="selected">No</option>
              <?php } ?>
          </select>
          </td>
        </tr>
        <tr>
          <td><span class="required">*</span> <?php echo $entry_allow_checkout; ?></td>
           <td>
          <select name="stock_status_allow_checkout">
              <?php if ($stock_status_allow_checkout) { ?>
              <option value="1" selected="selected">Yes</option>
              <option value="0">No</option>
              <?php } else { ?>
              <option value="1">Yes</option>
              <option value="0" selected="selected">No</option>
              <?php } ?>
          </select>
          </td>
        </tr>
		]]>
			</add>
		</operation>
	</file>

	<file name="admin/view/template/localisation/stock_status_list.tpl">
		<operation error="abort">
			<search position="before" index="1"><![CDATA[<td class="right"><?php echo $column_action; ?></td>]]></search>
			<add><![CDATA[
				<td class="left"><?php echo $column_hide_from_catalog; ?></td>
				<td class="left"><?php echo $column_allow_checkout; ?></td>
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="after" index="1"><![CDATA[<td class="left"><?php echo $stock_status['name']; ?></td>]]></search>
			<add><![CDATA[
			  <td class="left"><?php echo $stock_status['hide_from_catalog']; ?></td>
			  <td class="left"><?php echo $stock_status['allow_checkout']; ?></td>
		]]>
			</add>
		</operation>
	</file>

	<file name="catalog/model/catalog/product.php">
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$query = $this->db->query("SELECT DISTINCT *, pd.name AS name, p.image, m.name AS manufacturer, (SELECT category_id FROM ".DB_PREFIX."product_to_category WHERE product_id = p.product_id LIMIT 1) as category_id, (SELECT price FROM " . DB_PREFIX . "product_discount pd2 WHERE pd2.product_id = p.product_id AND pd2.customer_group_id = '" . (int)$customer_group_id . "' AND pd2.quantity = '1' AND ((pd2.date_start = '0000-00-00' OR pd2.date_start < NOW()) AND (pd2.date_end = '0000-00-00' OR pd2.date_end > NOW())) ORDER BY pd2.priority ASC, pd2.price ASC LIMIT 1) AS discount, (SELECT price FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = p.product_id AND ps.customer_group_id = '" . (int)$customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) AS special, (SELECT date_end FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = p.product_id AND ps.customer_group_id = '" . (int)$customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) AS special_end, (SELECT points FROM " . DB_PREFIX . "product_reward pr WHERE pr.product_id = p.product_id AND customer_group_id = '" . (int)$customer_group_id . "') AS reward, (SELECT ss.name FROM " . DB_PREFIX . "stock_status ss WHERE ss.stock_status_id = p.stock_status_id AND ss.language_id = '" . (int)$this->config->get('config_language_id') . "') AS stock_status, (SELECT wcd.unit FROM " . DB_PREFIX . "weight_class_description wcd WHERE p.weight_class_id = wcd.weight_class_id AND wcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS weight_class, (SELECT lcd.unit FROM " . DB_PREFIX . "length_class_description lcd WHERE p.length_class_id = lcd.length_class_id AND lcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS length_class, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating, (SELECT COUNT(*) AS total FROM " . DB_PREFIX . "review r2 WHERE r2.product_id = p.product_id AND r2.status = '1' GROUP BY r2.product_id) AS reviews, p.sort_order FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "manufacturer m ON (p.manufacturer_id = m.manufacturer_id) WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");]]></search>
			<add><![CDATA[
		$query = $this->db->query("SELECT DISTINCT *, pd.name AS name, p.image, m.name AS manufacturer, (SELECT category_id FROM ".DB_PREFIX."product_to_category WHERE product_id = p.product_id LIMIT 1) as category_id, (SELECT price FROM " . DB_PREFIX . "product_discount pd2 WHERE pd2.product_id = p.product_id AND pd2.customer_group_id = '" . (int)$customer_group_id . "' AND pd2.quantity = '1' AND ((pd2.date_start = '0000-00-00' OR pd2.date_start < NOW()) AND (pd2.date_end = '0000-00-00' OR pd2.date_end > NOW())) ORDER BY pd2.priority ASC, pd2.price ASC LIMIT 1) AS discount, (SELECT price FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = p.product_id AND ps.customer_group_id = '" . (int)$customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) AS special, (SELECT date_end FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = p.product_id AND ps.customer_group_id = '" . (int)$customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) AS special_end, (SELECT points FROM " . DB_PREFIX . "product_reward pr WHERE pr.product_id = p.product_id AND customer_group_id = '" . (int)$customer_group_id . "') AS reward, (SELECT ss.name FROM " . DB_PREFIX . "stock_status ss WHERE ss.stock_status_id = p.stock_status_id AND ss.language_id = '" . (int)$this->config->get('config_language_id') . "') AS stock_status, (SELECT wcd.unit FROM " . DB_PREFIX . "weight_class_description wcd WHERE p.weight_class_id = wcd.weight_class_id AND wcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS weight_class, (SELECT lcd.unit FROM " . DB_PREFIX . "length_class_description lcd WHERE p.length_class_id = lcd.length_class_id AND lcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS length_class, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating, (SELECT COUNT(*) AS total FROM " . DB_PREFIX . "review r2 WHERE r2.product_id = p.product_id AND r2.status = '1' GROUP BY r2.product_id) AS reviews, p.sort_order FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "manufacturer m ON (p.manufacturer_id = m.manufacturer_id) LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id WHERE (p.quantity > 0 OR ssa.hide_from_catalog = 0) AND  p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$sql = "SELECT p.product_id, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id)"; ]]></search>
			<add><![CDATA[
			$sql = "SELECT p.product_id, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id"; 
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[$sql .= " GROUP BY p.product_id";]]></search>
			<add><![CDATA[
$sql .= " AND (p.quantity > 0 OR ssa.hide_from_catalog = 0)";
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$sql = "SELECT DISTINCT ps.product_id, (SELECT AVG(rating) FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = ps.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating FROM " . DB_PREFIX . "product_special ps LEFT JOIN " . DB_PREFIX . "product p ON (ps.product_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) WHERE p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' AND ps.customer_group_id = '" . (int)$customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) GROUP BY ps.product_id";]]></search>
			<add><![CDATA[
		$sql = "SELECT DISTINCT ps.product_id, (SELECT AVG(rating) FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = ps.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating FROM " . DB_PREFIX . "product_special ps LEFT JOIN " . DB_PREFIX . "product p ON (ps.product_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id WHERE (p.quantity > 0 OR ssa.hide_from_catalog = 0) AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' AND ps.customer_group_id = '" . (int)$customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) GROUP BY ps.product_id";
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$query = $this->db->query("SELECT p.product_id FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) WHERE p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' ORDER BY p.date_added DESC LIMIT " . (int)$limit);]]></search>
			<add><![CDATA[
			$query = $this->db->query("SELECT p.product_id FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id WHERE (p.quantity > 0 OR ssa.hide_from_catalog = 0) AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' ORDER BY p.date_added DESC LIMIT " . (int)$limit);
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$query = $this->db->query("SELECT p.product_id FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) WHERE p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' ORDER BY p.viewed, p.date_added DESC LIMIT " . (int)$limit);]]></search>
			<add><![CDATA[
		$query = $this->db->query("SELECT p.product_id FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id WHERE (p.quantity > 0 OR ssa.hide_from_catalog = 0) AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' ORDER BY p.viewed, p.date_added DESC LIMIT " . (int)$limit);
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$query = $this->db->query("SELECT op.product_id, COUNT(*) AS total FROM " . DB_PREFIX . "order_product op LEFT JOIN `" . DB_PREFIX . "order` o ON (op.order_id = o.order_id) LEFT JOIN `" . DB_PREFIX . "product` p ON (op.product_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) WHERE o.order_status_id > '0' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' GROUP BY op.product_id ORDER BY total DESC LIMIT " . (int)$limit);]]></search>
			<add><![CDATA[
			$query = $this->db->query("SELECT op.product_id, COUNT(*) AS total FROM " . DB_PREFIX . "order_product op LEFT JOIN `" . DB_PREFIX . "order` o ON (op.order_id = o.order_id) LEFT JOIN `" . DB_PREFIX . "product` p ON (op.product_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id WHERE (p.quantity > 0 OR ssa.hide_from_catalog = 0) AND o.order_status_id > '0' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' GROUP BY op.product_id ORDER BY total DESC LIMIT " . (int)$limit);
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_related pr LEFT JOIN " . DB_PREFIX . "product p ON (pr.related_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) WHERE pr.product_id = '" . (int)$product_id . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");]]></search>
			<add><![CDATA[
$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_related pr LEFT JOIN " . DB_PREFIX . "product p ON (pr.related_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id WHERE (p.quantity > 0 OR ssa.hide_from_catalog = 0) AND pr.product_id = '" . (int)$product_id . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$sql .= " WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'";]]></search>
			<add><![CDATA[
			$sql .= " LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id";
			$sql .= " WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'";
			$sql .= " AND (p.quantity > 0 OR ssa.hide_from_catalog = 0)";
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="before" index="1"><![CDATA[if (isset($query->row['total'])) {]]></search>
			<add><![CDATA[
$query = $this->db->query("SELECT COUNT(DISTINCT ps.product_id) AS total FROM " . DB_PREFIX . "product_special ps LEFT JOIN " . DB_PREFIX . "product p ON (ps.product_id = p.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id WHERE (p.quantity > 0 OR ssa.hide_from_catalog = 0) AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' AND ps.customer_group_id = '" . (int)$customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW()))");
		]]>
			</add>
		</operation>
	</file>

	<file name="catalog/model/checkout/order.php">
		<operation error="abort">
			<search position="after" index="1"><![CDATA[$this->db->query("UPDATE " . DB_PREFIX . "product SET quantity = (quantity - " . (int)$order_product['quantity'] . ") WHERE product_id = '" . (int)$order_product['product_id'] . "' AND subtract = '1'");]]></search>
			<add><![CDATA[
				if ($this->db->countAffected() > 0) {
					$result = $this->db->query("SELECT quantity FROM " . DB_PREFIX . "product WHERE product_id = " . (int)$order_product['product_id']);
					$newdata = $result->row;
					$this->db->query("INSERT INTO " . DB_PREFIX . "stock_control (type, product_id, product_name, adjustment, new_quantity, notes, admin_id, 
date) VALUES (
					'order',
					" . (int)$order_product['product_id'] . ",
					'" . $this->db->escape($order_product['name']) . "',
					-" . (int)$order_product['quantity'] . ",
					" . (int)$newdata['quantity'] . ",
					'Order ID: " . $order_id . "',
					NULL,
					NOW())");
				}
		]]>
			</add>
		</operation>
	</file>

	<file name="system/library/cart.php">
		<operation error="abort">
			<search position="before" index="1"><![CDATA[if ($product_query->num_rows) {]]></search>
			<add><![CDATA[
				$product_query = $this->db->query("SELECT *, wcd.unit AS weight_class, mcd.unit AS length_class FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "weight_class wc ON (p.weight_class_id = wc.weight_class_id) LEFT JOIN " . DB_PREFIX . "weight_class_description wcd ON (wc.weight_class_id = wcd.weight_class_id) LEFT JOIN " . DB_PREFIX . "length_class mc ON (p.length_class_id = mc.length_class_id) LEFT JOIN " . DB_PREFIX . "length_class_description mcd ON (mc.length_class_id = mcd.length_class_id) WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND wcd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.date_available <= NOW() AND p.status = '1'");
				$product_query = $this->db->query("SELECT *, wcd.unit AS weight_class, mcd.unit AS length_class, ssa.allow_checkout FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "weight_class wc ON (p.weight_class_id = wc.weight_class_id) LEFT JOIN " . DB_PREFIX . "weight_class_description wcd ON (wc.weight_class_id = wcd.weight_class_id) LEFT JOIN " . DB_PREFIX . "length_class mc ON (p.length_class_id = mc.length_class_id) LEFT JOIN " . DB_PREFIX . "length_class_description mcd ON (mc.length_class_id = mcd.length_class_id) LEFT JOIN  " . DB_PREFIX . "stock_status_actions ssa ON ssa.stock_status_id = p.stock_status_id WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND wcd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.date_available <= NOW() AND p.status = '1'");
		]]>
			</add>
		</operation>
		<operation error="abort">
			<search position="replace" index="1"><![CDATA[$stock = false;]]></search>
			<add><![CDATA[
										if ($product_query->row['allow_checkout'] == 0) {
											$stock = FALSE;
										}
		]]>
			</add>
		</operation>
	</file>

</modification>
